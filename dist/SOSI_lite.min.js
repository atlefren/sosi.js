/*! SOSI 27-11-2015 */
function convert(a,b){var c=parser.parse(a).dumps(b);return JSON.stringify(c)}if("undefined"!=typeof require){var _=require("underscore"),proj4=require("proj4"),window=window||{};window.SOSI=window.SOSI||{}}var SOSI=window.SOSI||{};!function(a,b){"use strict";a.Base=function(){this.initialize.apply(this,arguments)},_.extend(a.Base.prototype,{initialize:function(){}}),a.Base.extend=function(a,b){var c,d=this;c=a&&_.has(a,"constructor")?a.constructor:function(){return d.apply(this,arguments)},_.extend(c,d,b);var e=function(){this.constructor=c};return e.prototype=d.prototype,c.prototype=new e,a&&_.extend(c.prototype,a),c.__super__=d.prototype,c}}(SOSI);var SOSI=window.SOSI||{};!function(a,b){"use strict";function c(a){return _.rest(a.split(" ")).join(" ").trim()}function d(a){return new Array(a+1).join(".")}function e(a){return-1!==a.indexOf(":")?_.first(a.split(":")).trim():_.first(a.split(" ")).trim()}function f(a){return-1!==a.indexOf("!")&&(a=a.substring(0,a.indexOf("!"))),a.replace(/\s+$/,"")}function g(a,b){return f(e(a.replace(d(b),"")))}function h(a,b){_.isArray(a.objects[a.key])||(a.objects[a.key]=[]),a.objects[a.key].push(b)}function i(a){var b=_.find(a,function(a){return"."!==a});return b&&(a=a.substr(0,_.indexOf(a,b))),_.every(a,function(a){return"."===a})?a.length:0}function j(a,b){return i(a)===b}function k(a){return""===a}function l(a,b){return _.reduce(_.reject(a,k),function(a,d){return d=f(d),j(d,b)&&(a.key=g(d,b),d=c(d)),k(d)||h(a,d),a},{objects:{}}).objects}function m(b,c){if(!a.types)return c;var d=_.isArray(b)?b:SOSI.types[b];if(d&&!_.isObject(d[0])){if("Integer"===d[1])return parseInt(c,10);if("Real"===d[1])return parseFloat(c);if("Date"===d[1]){if(8===c.length)return new Date(parseInt(c.substring(0,4),10),parseInt(c.substring(4,6),10)-1,parseInt(c.substring(6,8),10));if(14===c.length)return new Date(parseInt(c.substring(0,4),10),parseInt(c.substring(4,6),10)-1,parseInt(c.substring(6,8),10),parseInt(c.substring(8,10),10),parseInt(c.substring(10,12),10),parseInt(c.substring(12,14),10))}else if(_.isString(d[1]))return'"'===c[0]||"'"===c[0]?c.substring(1,c.length-1):c}return c}function n(a,b){return function(a){return a?_.isObject(a)?a:_.isString(a)?_.reduce(a.match(/"[^"]*"|'[^']*'|\S+/g),function(a,c,d){return a[b[d][0]]=m(b[d],c),a},{}):void 0:null}}function o(b){if(a.types&&a.types[b]){var c=a.types[b];return!!c&&c[0]||b}return b}function p(a){return _.reduce(l(a,3),function(a,b,c){return a[o(c)]=m(c,b[0]),a},{})}a.util={parseTree:l,cleanupLine:f,getLongname:o,parseFromLevel2:function(a){return _.reduce(l(a,2),function(a,b,c){return b.length&&("."===b[0][0]?a[o(c)]=p(b):b.length>1?a[o(c)]=_.map(b,function(a){return m(c,a)}):a[o(c)]=m(c,b[0])),a},{})},specialAttributes:function(){return SOSI.types?_.reduce(SOSI.types,function(a,b,c){return _.isObject(b[1])&&(a[b[0]]={name:b[0],createFunction:n(c,b[1])}),a},{}):void 0}(),round:function(a,b){var c=Math.pow(10,b);return Math.round(a*c)/c}},a.geosysMap={2:{srid:"EPSG:4326",def:"+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs "}},a.koordsysMap={1:{srid:"EPSG:27391",def:"+proj=tmerc +lat_0=58 +lon_0=-4.666666666666667 +k=1 +x_0=0 +y_0=0 +a=6377492.018 +b=6356173.508712696 +towgs84=278.3,93,474.5,7.889,0.05,-6.61,6.21 +pm=oslo +units=m +no_defs"},2:{srid:"EPSG:27392",def:"+proj=tmerc +lat_0=58 +lon_0=-2.333333333333333 +k=1 +x_0=0 +y_0=0 +a=6377492.018 +b=6356173.508712696 +towgs84=278.3,93,474.5,7.889,0.05,-6.61,6.21 +pm=oslo +units=m +no_defs"},3:{srid:"EPSG:27393",def:"+proj=tmerc +lat_0=58 +lon_0=0 +k=1 +x_0=0 +y_0=0 +a=6377492.018 +b=6356173.508712696 +towgs84=278.3,93,474.5,7.889,0.05,-6.61,6.21 +pm=oslo +units=m +no_defs"},4:{srid:"EPSG:27394",def:"+proj=tmerc +lat_0=58 +lon_0=2.5 +k=1 +x_0=0 +y_0=0 +a=6377492.018 +b=6356173.508712696 +towgs84=278.3,93,474.5,7.889,0.05,-6.61,6.21 +pm=oslo +units=m +no_defs"},5:{srid:"EPSG:27395",def:"+proj=tmerc +lat_0=58 +lon_0=6.166666666666667 +k=1 +x_0=0 +y_0=0 +a=6377492.018 +b=6356173.508712696 +towgs84=278.3,93,474.5,7.889,0.05,-6.61,6.21 +pm=oslo +units=m +no_defs"},6:{srid:"EPSG:27396",def:"+proj=tmerc +lat_0=58 +lon_0=10.16666666666667 +k=1 +x_0=0 +y_0=0 +a=6377492.018 +b=6356173.508712696 +towgs84=278.3,93,474.5,7.889,0.05,-6.61,6.21 +pm=oslo +units=m +no_defs"},7:{srid:"EPSG:27397",def:"+proj=tmerc +lat_0=58 +lon_0=14.16666666666667 +k=1 +x_0=0 +y_0=0 +a=6377492.018 +b=6356173.508712696 +towgs84=278.3,93,474.5,7.889,0.05,-6.61,6.21 +pm=oslo +units=m +no_defs"},8:{srid:"EPSG:27398",def:"+proj=tmerc +lat_0=58 +lon_0=18.33333333333333 +k=1 +x_0=0 +y_0=0 +a=6377492.018 +b=6356173.508712696 +towgs84=278.3,93,474.5,7.889,0.05,-6.61,6.21 +pm=oslo +units=m +no_defs"},9:{srid:"EPSG:4273",def:"+proj=longlat +a=6377492.018 +b=6356173.508712696 +towgs84=278.3,93,474.5,7.889,0.05,-6.61,6.21 +no_defs"},21:{srid:"EPSG:32631",def:"+proj=utm +zone=31 +ellps=WGS84 +datum=WGS84 +units=m +no_defs"},22:{srid:"EPSG:32632",def:"+proj=utm +zone=32 +ellps=WGS84 +datum=WGS84 +units=m +no_defs"},23:{srid:"EPSG:32633",def:"+proj=utm +zone=33 +ellps=WGS84 +datum=WGS84 +units=m +no_defs"},24:{srid:"EPSG:32634",def:"+proj=utm +zone=34 +ellps=WGS84 +datum=WGS84 +units=m +no_defs"},25:{srid:"EPSG:32635",def:"+proj=utm +zone=35 +ellps=WGS84 +datum=WGS84 +units=m +no_defs"},26:{srid:"EPSG:32636",def:"+proj=utm +zone=35 +ellps=WGS84 +datum=WGS84 +units=m +no_defs"},31:{srid:"EPSG:23031",def:"+proj=utm +zone=31 +ellps=intl +units=m +no_defs"},32:{srid:"EPSG:23032",def:"+proj=utm +zone=32 +ellps=intl +units=m +no_defs"},33:{srid:"EPSG:23033",def:"+proj=utm +zone=33 +ellps=intl +units=m +no_defs"},34:{srid:"EPSG:23034",def:"+proj=utm +zone=34 +ellps=intl +units=m +no_defs"},35:{srid:"EPSG:23035",def:"+proj=utm +zone=35 +ellps=intl +units=m +no_defs"},36:{srid:"EPSG:23036",def:"+proj=utm +zone=36 +ellps=intl +units=m +no_defs"},50:{srid:"EPSG:4230",def:"+proj=longlat +ellps=intl +no_defs"},72:{srid:"EPSG:4322",def:"+proj=longlat +ellps=WGS72 +no_defs "},84:{srid:"EPSG:4326",def:"+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs "},87:{srid:"EPSG:4231",def:"+proj=longlat +ellps=intl +no_defs "}},_.each(a.koordsysMap,function(a){_.isUndefined(window.proj4)?_.isUndefined(window.Proj4js)||(Proj4js.defs[a.srid]=a.def):proj4.defs(a.srid,a.def)})}(SOSI);var SOSI=window.SOSI||{};!function(a,b){"use strict";function c(a,b){var c=a[b]||"";return c.replace(/"/g,"")}function d(a,b){return parseFloat(a[b])}function e(b){if(b=parseInt(b,10),a.koordsysMap[b])return a.koordsysMap[b].srid;throw new Error("KOORDSYS = "+b+" not found!")}function f(b){if(_.isArray(b))throw new Error("GEOSYS cannot be parsed in uncompacted form yet.");if(b=b.split(/\s+/),a.geosysMap[b[0]])return a.geosysMap[b[0]].srid;throw new Error("GEOSYS = "+b+" not found!")}function g(a){var b=a["MIN-NØ"].split(/\s+/),c=a["MAX-NØ"].split(/\s+/);return[parseFloat(b[1]),parseFloat(b[0]),parseFloat(c[1]),parseFloat(c[0])]}function h(a){return a=_.filter(a.split(/\s+/),function(a){return""!==a}),{x:parseFloat(a[1]),y:parseFloat(a[0])}}function i(a){return a.TRANSPAR.enhet?parseFloat(a.TRANSPAR.enhet):parseFloat(a.TRANSPAR.ENHET)}a.Head=a.Base.extend({initialize:function(a){this.setData(a)},parse:function(b){return a.util.parseFromLevel2(b)},setData:function(b){b=this.parse(b),this.eier=c(b,a.util.getLongname("EIER")),this.produsent=c(b,a.util.getLongname("PRODUSENT")),this.objektkatalog=b[a.util.getLongname("OBJEKTKATALOG")],this.verifiseringsdato=b[a.util.getLongname("VERIFISERINGSDATO")],this.version=d(b,a.util.getLongname("SOSI-VERSJON")),this.level=d(b,a.util.getLongname("SOSI-NIVÅ")),SOSI.types?this.kvalitet=a.util.specialAttributes[a.util.getLongname("KVALITET")].createFunction(b[a.util.getLongname("KVALITET")]):this.kvalitet=c(b,a.util.getLongname("KVALITET")),this.bbox=g(b["OMRÅDE"]),this.origo=h(b.TRANSPAR["ORIGO-NØ"]),this.enhet=i(b),this.vertdatum=c(b.TRANSPAR,"VERT-DATUM"),b.TRANSPAR.KOORDSYS?this.srid=e(b.TRANSPAR.KOORDSYS):this.srid=f(b.TRANSPAR.GEOSYS)}})}(SOSI);var SOSI=window.SOSI||{};!function(a,b){"use strict";function c(a){return _.filter(a,function(a){return-1===a.indexOf("NØ")})}function d(a,b){var c=_.flatten(_.map(a,function(a){var c=Math.abs(a),d=b.getById(c);if(!d)throw new Error("Fant ikke KURVE "+c+" for FLATE");var e=d.geometry.kurve;return 0>a&&(e=_.clone(e).reverse()),_.initial(e)}));return c.push(c[0]),c}function e(a){return _.map(a.trim().split(" "),function(a){return parseInt(a.replace(":",""),10)})}a.Point=a.Base.extend({knutepunkt:!1,initialize:function(b,c,d){if(_.isNumber(b))return this.x=b,void(this.y=c);_.isArray(b)&&(b=b[1]);var e=b.split(/\s+/),f=0;1>d&&(f=-Math.floor(Math.log(d)/Math.LN10)),this.y=a.util.round(parseInt(e[0],10)*d+c.y,f),this.x=a.util.round(parseInt(e[1],10)*d+c.x,f),e[2]&&!isNaN(e[2])&&(this.z=a.util.round(parseInt(e[2],10)*d,f)),-1!==b.indexOf(".KP")&&this.setTiepoint(b.substring(b.indexOf(".KP"),b.length).split(" ")[1])},setTiepoint:function(a){this.has_tiepoint=!0,this.knutepunktkode=parseInt(a,10)}}),a.LineString=a.Base.extend({initialize:function(b,c,d){this.kurve=_.compact(_.map(b,function(b){return-1===b.indexOf("NØ")?new a.Point(b,c,d):void 0})),this.knutepunkter=_.filter(this.kurve,function(a){return a.has_tiepoint})}}),a.LineStringFromArc=a.LineString.extend({initialize:function(b,d,e){var f=_.map(c(b),function(b){return new a.Point(b,d,e)});if(3!==f.length)throw new Error("BUEP er ikke definert med 3 punkter");var g=f[0].x,h=f[1].x,i=f[2].x,j=f[0].y,k=f[1].y,l=f[2].y,m=(g*g-h*h+j*j-k*k)/2,n=(g*g-i*i+j*j-l*l)/2,o=g-h,p=g-i,q=j-k,r=j-l,s=(r*m-q*n)/(o*r-q*p),t=(p*m-o*n)/(q*p-o*r),u=Math.sqrt(Math.pow(g-s,2)+Math.pow(j-t,2)),v=Math.atan2(j-t,g-s),w=Math.atan2(l-t,i-s),x=w-v;0>x&&(x+=2*Math.PI),x>Math.PI&&(x=-2*Math.PI+x);var y=Math.floor(32*x/2*Math.PI);0>y&&(y=-y),3>y&&(y=3),x/=y-1,this.kurve=_.map(_.range(y),function(b){var c=s+u*Math.cos(v+x*b),d=t+u*Math.sin(v+x*b);if(isNaN(c))throw new Error("BUEP: Interpolated "+c+" for point "+b+" of "+y+" in curve.");return new a.Point(c,d)}),this.knutepunkter=_.filter(f,function(a){return a.has_tiepoint})}}),a.Polygon=a.Base.extend({initialize:function(a,b){var c=a,f=[],g=a.indexOf("(");-1!==g&&(c=a.substr(0,g),f=a.substr(g,a.length)),c=e(c),f=_.map(_.reduce(f,function(a,b){return"("===b?a.push(""):")"!==b&&""!==b&&(a[a.length-1]+=b),a},[]),e),this.flate=d(c,b),this.holes=_.map(f,function(a){if(1===a.length){var c=b.getById(Math.abs(a[0]));if("FLATE"===c.geometryType)return c.geometry.flate}return d(a,b)}),this.shellRefs=c,this.holeRefs=f}})}(SOSI);var SOSI=window.SOSI||{};!function(a,b){"use strict";function c(b,c,d,e){var f={PUNKT:a.Point,TEKST:a.Point,KURVE:a.LineString,BUEP:a.LineStringFromArc,LINJE:a.LineString,FLATE:a.Polygon};if(!f[b])throw new Error("GeometryType "+b+" is not handled (yet..?)");return new f[b](c,d,e)}a.Feature=a.Base.extend({initialize:function(a,c,d,e){if(a.id===b||null===a.id)throw new Error("Feature must have ID!");this.id=a.id,this.parseData(a,c,d,e),this.geometryType=a.geometryType},parseData:function(b,c,d){var e=_.reduce(b.lines,function(a,b){if(-1!==b.indexOf("..NØ")){var c=b.split(" ");c.length>1&&(a.geom.push(c[0]),a.geom.push(b.replace(c[0]+" ",""))),a.foundGeom=!0}return a.foundGeom?a.geom.push(b):(-1!==b.indexOf("..REF")&&(a.foundRef=!0,b=b.replace("..REF","")),a.foundRef?"."===b[0]?a.foundRef=!1:a.refs.push(b):a.attributes.push(b)),a},{attributes:[],geom:[],refs:[],foundGeom:!1,foundRef:!1});this.attributes=a.util.parseFromLevel2(e.attributes),this.attributes=_.reduce(this.attributes,function(b,c,d){return a.util.specialAttributes&&a.util.specialAttributes[d]?b[d]=a.util.specialAttributes[d].createFunction(c):b[d]=c,b},{}),e.refs.length>0&&(this.attributes.REF=e.refs.join(" ")),this.attributes.ENHET&&(d=parseFloat(this.attributes.ENHET)),this.raw_data={geometryType:b.geometryType,geometry:e.geom,origo:c,unit:d}},buildGeometry:function(b){"FLATE"===this.raw_data.geometryType?(this.geometry=new a.Polygon(this.attributes.REF,b),this.geometry.center=new a.Point(this.raw_data.geometry,this.raw_data.origo,this.raw_data.unit),this.attributes=_.omit(this.attributes,"REF")):this.geometry=c(this.raw_data.geometryType,this.raw_data.geometry,this.raw_data.origo,this.raw_data.unit),this.raw_data=null}}),a.Features=a.Base.extend({initialize:function(b,c){this.head=c,this.index=[],this.features=_.object(_.map(b,function(b,d){d=d.replace(":","").split(/\s+/);var e={id:parseInt(d[1],10),geometryType:d[0],lines:_.rest(b)};return this.index.push(e.id),[e.id,new a.Feature(e,c.origo,c.enhet)]},this))},ensureGeom:function(a){return a&&!a.geometry&&a.buildGeometry(this),a},length:function(){return _.size(this.features)},at:function(a){return this.getById(this.index[a])},getById:function(a){return this.ensureGeom(this.features[a])},all:function(a){return a?_.map(this.index,this.getById,this):_.map(this.features,this.ensureGeom,this)}})}(SOSI);var SOSI=window.SOSI||{};!function(a,b){"use strict";function c(a){var b=[a.x,a.y];return _.has(a,"z")&&b.push(a.z),b}function d(a,b){return _.map(a,function(a){var c=b[Math.abs(a)].index;return a>0?c:-(Math.abs(c)+1)})}a.Sosi2GeoJSON=a.Base.extend({initialize:function(a){this.sosidata=a},dumps:function(){return{type:"FeatureCollection",features:this.getFeatures(),crs:this.writeCrs()}},getFeatures:function(){return _.map(this.sosidata.features.all(),this.createGeoJsonFeature,this)},createGeoJsonFeature:function(a){return{type:"Feature",id:a.id,properties:a.attributes,geometry:this.writeGeometry(a.geometry)}},writeGeometry:function(b){if(b instanceof a.Point)return{type:"Point",coordinates:c(b)};if(b instanceof a.LineString)return{type:"LineString",coordinates:_.map(b.kurve,c)};if(b instanceof a.Polygon){var d=_.map(b.flate,c),e=_.map(b.holes,function(a){return _.map(a,c)});return{type:"Polygon",coordinates:[d].concat(e)}}throw new Error("cannot write geometry!")},writeCrs:function(){return{type:"name",properties:{name:this.sosidata.hode.srid}}}}),a.Sosi2TopoJSON=a.Base.extend({initialize:function(a){this.sosidata=a},dumps:function(a){var b=this.getPoints(),c=this.getLines(),d=this.getPolygons(c),e=b.concat(_.map(c,function(a){return a.geometry})).concat(d),f={type:"Topology",objects:{}};f.objects[a]={type:"GeometryCollection",geometries:e};var g=_.map(_.sortBy(c,function(a){return a.index}),function(a){return a.arc});return g.length&&(f.arcs=g),f},getByType:function(a){return _.filter(this.sosidata.features.all(),function(b){return b.geometry instanceof a})},getPoints:function(){var b=this.getByType(a.Point);return _.map(b,function(a){var b=_.clone(a.attributes);return b.id=a.id,{type:"Point",properties:b,coordinates:c(a.geometry)}})},getLines:function(){var b=this.getByType(a.LineString);return _.reduce(b,function(a,b,d){var e=_.clone(b.attributes);return e.id=b.id,a[b.id]={geometry:{type:"LineString",properties:e,arcs:[d]},arc:_.map(b.geometry.kurve,c),index:d},a},{})},getPolygons:function(b){var c=this.getByType(a.Polygon);return _.map(c,function(c){var e=_.clone(c.attributes);e.id=c.id;var f=[d(c.geometry.shellRefs,b)];return f=f.concat(_.map(c.geometry.holeRefs,function(c){if(1===c.length){var e=this.sosidata.features.getById(Math.abs(c[0]));if(e.geometry instanceof a.Polygon)return d(e.geometry.shellRefs,b)}return d(c,b)},this)),{type:"Polygon",properties:e,arcs:f}},this)}})}(SOSI);var SOSI=window.SOSI||{};if(function(a,b){"use strict";function c(a){return _.map(a.split("\n"),function(a){return 0!==a.indexOf("!")&&(a=a.split("!")[0]),a.replace(/^\s+|\s+$/g,"")})}var d=a.Base.extend({}),e=a.Base.extend({}),f={geojson:a.Sosi2GeoJSON,topojson:a.Sosi2TopoJSON},g=a.Base.extend({initialize:function(b){this.hode=new a.Head(b.HODE||b["HODE 0"]),this.def=new d(b.DEF),this.objdef=new e(b.OBJDEF),this.features=new a.Features(_.omit(b,["HODE","HODE 0","DEF","OBJDEF","SLUTT"]),this.hode)},dumps:function(a){if(f[a])return new f[a](this).dumps(_.rest(arguments));throw new Error("Outputformat "+a+" is not supported!")}});a.Parser=a.Base.extend({parse:function(b){return new g(a.util.parseTree(c(b),1))},getFormats:function(){return _.keys(f)}})}(SOSI),"undefined"!=typeof require){var fs=require("fs"),util=require("util"),parser=new SOSI.Parser;process.argv.length<4&&(util.print("\nusage: nodejs SOSI.js.js format infile.sos > outfile\n\nwhere: format     : one of ["+parser.getFormats()+"]\n       infile.sos : a file in SOSI format\n       outfile    : an output file name, omit for stdout\n\n"),process.exit(1));var format=process.argv[2],filename=process.argv[3],data=fs.readFileSync(filename,"utf8"),encoding=data.substring(0,500).match(/TEGNSETT.*/).toString();if(encoding=encoding.split(/\s+/)[1].match(/\S+/).toString(),encoding&&"UTF8"!==encoding){var Iconv=require("iconv").Iconv,converter=new Iconv(encoding,"UTF-8");data=fs.readFileSync(filename,encoding=null),data=converter.convert(data).toString()}util.print(convert(data,format))}